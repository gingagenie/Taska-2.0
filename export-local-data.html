<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taska Data Export Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .export-area {
            margin-top: 20px;
        }
        textarea {
            width: 100%;
            height: 400px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Taska Data Export Tool</h1>
        <p class="subtitle">Extract locally stored business data for migration to Neon database</p>

        <div class="info">
            <strong>üìã What this tool does:</strong><br>
            ‚Ä¢ Scans your browser's localStorage for Taska business data<br>
            ‚Ä¢ Exports customers, equipment, jobs, quotes, and invoices<br>
            ‚Ä¢ Generates SQL statements ready for database migration<br>
            ‚Ä¢ Organizes data by organization (Fix my Forklift, Be Chill Automotive)
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Important:</strong> Make sure you're on the same browser/device where you were using the original Fix my Forklift and Be Chill Automotive data.
        </div>

        <button onclick="exportAllData()">üöÄ Export All Local Data</button>
        <button onclick="exportStorageKeys()">üîë Show All Storage Keys</button>
        <button onclick="clearOutput()">üßπ Clear Output</button>

        <div class="export-area">
            <textarea id="output" placeholder="Click 'Export All Local Data' to see your stored business data here..."></textarea>
        </div>
    </div>

    <script>
        function exportStorageKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                keys.push(localStorage.key(i));
            }
            
            const output = document.getElementById('output');
            output.value = `Found ${keys.length} localStorage keys:\n\n` + 
                          keys.sort().map((key, i) => `${i+1}. ${key}`).join('\n') +
                          '\n\n' + keys.map(key => `${key}: ${localStorage.getItem(key)?.substring(0, 100)}...`).join('\n\n');
        }

        function exportAllData() {
            const output = document.getElementById('output');
            let exportData = {
                timestamp: new Date().toISOString(),
                localStorage: {},
                organizations: {},
                summary: {
                    totalItems: 0,
                    categories: {}
                }
            };

            // Get all localStorage data
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                exportData.localStorage[key] = value;
                
                // Try to parse JSON values
                try {
                    const parsed = JSON.parse(value);
                    if (Array.isArray(parsed)) {
                        exportData.summary.categories[key] = `Array with ${parsed.length} items`;
                        exportData.summary.totalItems += parsed.length;
                    } else if (typeof parsed === 'object') {
                        exportData.summary.categories[key] = 'Object';
                        exportData.summary.totalItems += 1;
                    }
                } catch {
                    exportData.summary.categories[key] = 'String value';
                }
            }

            // Organization mappings for Fix my Forklift and Be Chill Automotive
            const orgMappings = {
                'Fix my Forklift': '140443e9-6d3d-4543-87df-647f89d7228c',
                'Be Chill Automotive': '620a4462-c789-4a3e-9454-05e1e442246e',
                'Be Chill': '620a4462-c789-4a3e-9454-05e1e442246e'
            };

            // Generate SQL migration statements
            let sqlStatements = [];
            sqlStatements.push('-- Taska Data Migration SQL');
            sqlStatements.push('-- Generated: ' + new Date().toISOString());
            sqlStatements.push('-- Organizations: Fix my Forklift, Be Chill Automotive\n');

            // Look for customer/equipment/job data patterns
            const dataTypes = ['customers', 'equipment', 'jobs', 'quotes', 'invoices'];
            
            for (const [key, value] of Object.entries(exportData.localStorage)) {
                try {
                    const parsed = JSON.parse(value);
                    
                    // Check if this looks like business data
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        const sample = parsed[0];
                        
                        // Customers data
                        if (sample.name && (sample.email || sample.phone)) {
                            sqlStatements.push(`-- Found ${parsed.length} customers in localStorage key: ${key}`);
                            parsed.forEach((customer, idx) => {
                                const orgId = customer.orgName ? orgMappings[customer.orgName] || 'unknown-org' : 'unknown-org';
                                sqlStatements.push(
                                    `INSERT INTO customers (org_id, name, contact_name, email, phone, address, notes) ` +
                                    `VALUES ('${orgId}', ${SQL.string(customer.name)}, ${SQL.string(customer.contactName || '')}, ` +
                                    `${SQL.string(customer.email || '')}, ${SQL.string(customer.phone || '')}, ` +
                                    `${SQL.string(customer.address || '')}, ${SQL.string(customer.notes || '')});`
                                );
                            });
                            sqlStatements.push('');
                        }
                        
                        // Equipment data
                        if (sample.name && (sample.make || sample.model)) {
                            sqlStatements.push(`-- Found ${parsed.length} equipment in localStorage key: ${key}`);
                            parsed.forEach((equip, idx) => {
                                const orgId = equip.orgName ? orgMappings[equip.orgName] || 'unknown-org' : 'unknown-org';
                                sqlStatements.push(
                                    `INSERT INTO equipment (org_id, name, make, model, serial) ` +
                                    `VALUES ('${orgId}', ${SQL.string(equip.name)}, ${SQL.string(equip.make || '')}, ` +
                                    `${SQL.string(equip.model || '')}, ${SQL.string(equip.serial || '')});`
                                );
                            });
                            sqlStatements.push('');
                        }
                        
                        // Jobs data  
                        if (sample.title && sample.status) {
                            sqlStatements.push(`-- Found ${parsed.length} jobs in localStorage key: ${key}`);
                            parsed.forEach((job, idx) => {
                                const orgId = job.orgName ? orgMappings[job.orgName] || 'unknown-org' : 'unknown-org';
                                sqlStatements.push(
                                    `INSERT INTO jobs (org_id, title, description, status, notes) ` +
                                    `VALUES ('${orgId}', ${SQL.string(job.title)}, ${SQL.string(job.description || '')}, ` +
                                    `${SQL.string(job.status)}, ${SQL.string(job.notes || '')});`
                                );
                            });
                            sqlStatements.push('');
                        }
                    }
                } catch (e) {
                    // Not JSON data, skip
                }
            }

            const fullReport = `
TASKA DATA EXPORT REPORT
========================
Generated: ${exportData.timestamp}

SUMMARY:
--------
Total localStorage items: ${Object.keys(exportData.localStorage).length}
Data categories found: ${Object.keys(exportData.summary.categories).length}
Estimated business records: ${exportData.summary.totalItems}

CATEGORIES:
-----------
${Object.entries(exportData.summary.categories).map(([k,v]) => `${k}: ${v}`).join('\n')}

ORGANIZATION MAPPINGS:
---------------------
Fix my Forklift ‚Üí 140443e9-6d3d-4543-87df-647f89d7228c
Be Chill Automotive ‚Üí 620a4462-c789-4a3e-9454-05e1e442246e

FULL LOCALSTORAGE DATA:
-----------------------
${JSON.stringify(exportData.localStorage, null, 2)}

SQL MIGRATION STATEMENTS:
-------------------------
${sqlStatements.join('\n')}

========================
INSTRUCTIONS FOR MIGRATION:
1. Copy the SQL statements from the "SQL MIGRATION STATEMENTS" section above
2. Run them in your database to migrate the local data to Neon
3. Verify the data appears correctly in your app after running the SQL
========================
`;

            output.value = fullReport;
        }

        function clearOutput() {
            document.getElementById('output').value = '';
        }

        // SQL helper to properly escape strings
        const SQL = {
            string: function(str) {
                if (!str) return "''";
                return "'" + String(str).replace(/'/g, "''") + "'";
            }
        };

        // Auto-run export on page load if localStorage has data
        window.addEventListener('load', function() {
            if (localStorage.length > 0) {
                document.getElementById('output').value = 
                    'Ready to export! Click "Export All Local Data" to scan your browser storage.\n\n' +
                    `Found ${localStorage.length} items in localStorage that might contain your business data.`;
            } else {
                document.getElementById('output').value = 
                    'No localStorage data found. Make sure you\'re on the same browser/device where you used Fix my Forklift and Be Chill Automotive.';
            }
        });
    </script>
</body>
</html>